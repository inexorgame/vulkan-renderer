name: Release
on:
  workflow_run:
    workflows:
      - Build Code
    branches:
      - main
    types:
      - completed

jobs:
  nightly-release:
    name: Nightly Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Nightly_
          path: archives

      - name: Prepare Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f nightly
          git push -f https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git nightly

      - name: Create Nightly Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTES: |
            Latest development release, continuously updated.
        run: |
          # Handle Windows zip and Linux tar.xz
          mkdir -p archives_all
          cp archives/*.zip archives_all/ 2>/dev/null || true
          for f in archives/*.tar.xz 2>/dev/null; do
            tar -xf "$f" -C archives_all
          done

          # Create release
          gh release delete nightly -y || true
          gh release create nightly archives_all/* \
            --title "Nightly Release" \
            --notes "${{ env.NOTES }}" \
            --prerelease \
            --target ${{ github.sha }}
